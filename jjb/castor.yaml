# CASTOR - CAche STORage
#
# Emptied due to T171148
- publisher:
    name: castor-save
    publishers:
        - postbuildscript:
            script-only-if-succeed: True
            builders:
                - shell: echo "Castor is disabled https://phabricator.wikimedia.org/T171148"

- builder:
    name: castor-load
    builders:
        - shell: echo "Castor is disabled https://phabricator.wikimedia.org/T171148"

# Job triggered on the central repository instance
#
# Rsync from an instance using the Nodepool 'jenkins' credential.  The ssh key
# is made available via an ssh-agent and injected by Jenkins credentials store.
#
- job:
    name: castor-save
    node: castor
    concurrent: true
    properties:
     - build-discarder:
         days-to-keep: 5
    parameters:
        - string:
            name: TRIGGERED_SSH_CONNECTION
            description: 'SSH_CONNECTION of upstream job (contains IP of remote instance)'
        - string:
            name: TRIGGERED_JOB_NAME
            description: 'JOB_NAME of upstream job'
        - string:
            name: ZUUL_PIPELINE
            description: 'Name of Zuul pipeline. Must be gate-and-submit or postmerge to actually save cache.'
    wrappers:
        - ansicolor
        - timeout:
            timeout: 1  # minutes
            abort: false
            fail: false
        - timestamps
        - ssh-agent-credentials:
            users:
             - 'nodepool-dib-jenkins'

    builders:
        # This is horrible. Will need a better system that just prevent the job
        # from being triggered by the upstream job.
        - shell:
            !include-raw: castor-save-filter.bash
        - shell:
            !include-raw:
                - castor-define-namespace.bash
                - castor-save-sync.bash
